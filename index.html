<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoChives Videos - Premium YouTube Experience, Zero Cost</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTm9DaGl2ZXMgVmlkZW9zIiwic2hvcnRfbmFtZSI6Ik5vQ2hpdmVzIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYTBhMGEiLCJ0aGVtZV9jb2xvciI6IiNGRjAwNkUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00zUXViM0puTHpJd01EQXZjM1puSWlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0krUEhKbFkzUWdlRDBpTUNJZ2VUMGlNQ0lnZDJsa2RHZzlJakV5T0NJZ2FHVnBaMmgwUFNJeE1qZ2lJR1pwYkd3OUlpTkdSakF3Tm1VaUx6NDhMM04yWno0PSIsInNpemVzIjoiMTI4eDEyOCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#FF006E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-pink: #FF006E;
            --neon-blue: #00D9FF;
            --electric-purple: #B042FF;
            --cyber-green: #39FF14;
            --dark-bg-primary: #0a0a0a;
            --dark-bg-secondary: #121212;
            --dark-bg-card: #1a1a1a;
            --light-bg-primary: #f5f5f5;
            --light-bg-secondary: #ffffff;
            --light-bg-card: #fafafa;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-accent: #00D9FF;
            --border-glow: rgba(255, 0, 110, 0.5);
            --shadow-glow: 0 0 20px rgba(255, 0, 110, 0.3);
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --dark-bg-primary: var(--light-bg-primary);
            --dark-bg-secondary: var(--light-bg-secondary);
            --dark-bg-card: var(--light-bg-card);
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-glow: rgba(255, 0, 110, 0.3);
            --shadow-glow: 0 0 15px rgba(255, 0, 110, 0.2);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg-primary) 0%, var(--dark-bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background grid */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 0, 110, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 110, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 3rem 0;
            position: relative;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-blue), var(--electric-purple));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
            margin-bottom: 1rem;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--text-accent);
            font-weight: 300;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Video Player Section */
        .player-section {
            margin: 3rem 0;
            position: relative;
        }

        .video-input {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .url-input {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid rgba(255, 0, 110, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Rajdhani', sans-serif;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .url-input:focus {
            outline: none;
            border-color: var(--neon-pink);
            box-shadow: var(--shadow-glow);
        }

        .url-input::placeholder {
            color: var(--text-secondary);
        }

        .play-btn, .btn {
            padding: 1rem 2rem;
            background: linear-gradient(45deg, var(--neon-pink), var(--electric-purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
        }

        .play-btn:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 0, 110, 0.4);
        }

        .play-btn::before, .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .play-btn:hover::before, .btn:hover::before {
            left: 100%;
        }

        /* Video Player */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 0, 110, 0.3);
            box-shadow: var(--shadow-glow);
            background: var(--dark-bg-card);
        }

        .video-container.loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 450px;
        }

        .video-player {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
            background: #000;
        }

        .video-info {
            padding: 1.5rem;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
        }

        .video-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .video-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Loading Spinner */
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 0, 110, 0.3);
            border-top: 3px solid var(--neon-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Features Grid */
        .features {
            margin: 4rem 0;
        }

        .section-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 3rem;
            color: var(--text-accent);
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-blue), var(--electric-purple));
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-pink);
            box-shadow: 0 15px 30px rgba(255, 0, 110, 0.3);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .feature-desc {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* History Section */
        .history {
            margin: 4rem 0;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .history-list {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem 0;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-pink) transparent;
        }

        .history-list::-webkit-scrollbar {
            height: 8px;
        }

        .history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--neon-pink);
            border-radius: 10px;
        }

        .history-item {
            min-width: 200px;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .history-item:hover {
            border-color: var(--neon-pink);
            transform: translateY(-2px);
        }

        .history-thumbnail {
            width: 100%;
            height: 100px;
            background: var(--dark-bg-secondary);
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 0, 110, 0.2);
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            color: var(--neon-pink);
            background: rgba(255, 0, 110, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--neon-pink);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* API Key Status */
        .api-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .api-status.valid {
            background: rgba(57, 255, 20, 0.2);
            color: var(--cyber-green);
            border: 1px solid var(--cyber-green);
        }

        .api-status.invalid {
            background: rgba(255, 0, 85, 0.2);
            color: #FF0055;
            border: 1px solid #FF0055;
        }

        /* Search Section */
        .search-container {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Rajdhani', sans-serif;
            margin-bottom: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .search-filters {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }

        .filters-toggle {
            background: none;
            border: none;
            color: var(--text-accent);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filters-content {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filters-content.open {
            display: grid;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-select {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 5px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
        }

        /* Search Results */
        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .video-card {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .video-card:hover {
            border-color: var(--neon-pink);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 0, 110, 0.3);
        }

        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--dark-bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .video-card-content {
            padding: 1rem;
        }

        .video-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-card-channel {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .video-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .pagination-btn {
            padding: 0.7rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--neon-pink);
            border-color: var(--neon-pink);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Playlist Section */
        .playlist-info {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .playlist-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .playlist-meta {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .playlist-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .playlist-videos {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .playlist-video {
            display: flex;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .playlist-video:hover {
            border-color: var(--neon-pink);
            transform: translateX(5px);
        }

        .playlist-video-thumbnail {
            width: 120px;
            height: 90px;
            background: var(--dark-bg-secondary);
            flex-shrink: 0;
        }

        .playlist-video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-video-content {
            padding: 1rem;
            flex: 1;
        }

        .playlist-video-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
            line-height: 1.3;
        }

        .playlist-video-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .playlist-position {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            background: var(--neon-pink);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Loading States */
        .loading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .loading-card {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 0, 110, 0.2);
            border-radius: 10px;
            overflow: hidden;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            background: rgba(255, 255, 255, 0.1);
        }

        .loading-content {
            padding: 1rem;
        }

        .loading-line {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .loading-line.short {
            width: 60%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Settings Panel */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, var(--neon-pink), var(--electric-purple));
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1000;
        }

        .settings-toggle:hover {
            transform: rotate(45deg) scale(1.1);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-left: 2px solid rgba(255, 0, 110, 0.3);
            padding: 2rem;
            transition: var(--transition);
            z-index: 999;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            color: var(--text-accent);
        }

        .setting-item {
            margin-bottom: 2rem;
        }

        .setting-section {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 0, 110, 0.2);
        }

        .setting-section:last-child {
            border-bottom: none;
        }

        .setting-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--neon-pink);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-key-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 5px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--neon-pink);
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.3);
        }

        .warning-box {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #FFD700;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 0.5rem;
        }

        .quota-info {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--neon-blue);
            font-size: 0.85rem;
        }

        .quota-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .quota-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyber-green), var(--neon-blue), var(--neon-pink));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .btn-test {
            background: linear-gradient(45deg, var(--neon-blue), var(--electric-purple));
            margin-right: 0.5rem;
        }

        .btn-instructions {
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
        }

        .btn-instructions:hover {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .setting-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .setting-toggle.active {
            background: var(--neon-pink);
        }

        .setting-toggle::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .setting-toggle.active::before {
            transform: translateX(30px);
        }

        .setting-select {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            border-radius: 5px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
        }

        /* About Section */
        .about {
            margin: 4rem 0;
            text-align: center;
        }

        .about-card {
            max-width: 600px;
            margin: 2rem auto;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 20px;
            padding: 3rem;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .about-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--neon-blue), var(--electric-purple), var(--neon-pink));
            border-radius: 20px;
            z-index: -1;
            animation: gradientShift 4s ease-in-out infinite;
        }

        .about-name {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-blue);
            margin-bottom: 0.5rem;
        }

        .about-title {
            font-size: 1.2rem;
            color: var(--electric-purple);
            margin-bottom: 1.5rem;
        }

        .about-desc {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        /* Footer */
        .footer {
            margin-top: 6rem;
            padding: 3rem 0;
            background: rgba(16, 16, 16, 0.9);
            border-top: 1px solid rgba(255, 0, 110, 0.3);
            text-align: center;
        }

        .donation-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .donation-btn {
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--neon-blue);
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .donation-btn:hover {
            background: var(--neon-blue);
            color: var(--dark-bg-primary);
            transform: translateY(-2px);
        }

        .footer-text {
            color: var(--text-secondary);
            margin: 1rem 0;
        }

        .made-by {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--neon-pink);
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        /* Responsive */
        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }

            .video-input {
                flex-direction: column;
            }

            .url-input {
                min-width: auto;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .settings-panel {
                width: 100vw;
                right: -100vw;
            }

            .donation-links {
                flex-direction: column;
                align-items: center;
            }

            .tabs {
                flex-wrap: wrap;
                justify-content: center;
            }

            .tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }

            .search-results {
                grid-template-columns: 1fr;
            }

            .api-status {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 1rem;
                display: inline-block;
            }

            .filters-content {
                grid-template-columns: 1fr;
            }

            .playlist-video {
                flex-direction: column;
            }

            .playlist-video-thumbnail {
                width: 100%;
                height: 180px;
            }

            .pagination {
                flex-wrap: wrap;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            transform: translateX(400px);
            transition: var(--transition);
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(45deg, var(--cyber-green), #2ecc71);
        }

        .toast.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .toast.info {
            background: linear-gradient(45deg, var(--neon-blue), var(--electric-purple));
        }

        .toast.warning {
            background: linear-gradient(45deg, #FFD700, #f39c12);
            color: #000;
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid var(--neon-pink);
            border-radius: 15px;
            padding: 1.5rem;
            transform: translateY(200px);
            transition: var(--transition);
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .install-prompt.show {
            transform: translateY(0);
        }

        .install-prompt-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .install-prompt-text {
            flex: 1;
            min-width: 200px;
        }

        .install-prompt-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .install-prompt-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .install-prompt-actions {
            display: flex;
            gap: 1rem;
        }

        .install-btn {
            padding: 0.7rem 1.5rem;
            background: var(--neon-pink);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .install-btn:hover {
            background: var(--electric-purple);
        }

        .dismiss-btn {
            padding: 0.7rem 1.5rem;
            background: transparent;
            border: 1px solid var(--text-secondary);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            cursor: pointer;
            transition: var(--transition);
        }

        .dismiss-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        /* Error/Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Settings Toggle -->
    <button class="settings-toggle" id="settingsToggle" title="Settings">
        ‚öôÔ∏è
    </button>

    <!-- API Key Status -->
    <div class="api-status invalid" id="apiStatus">
        üîë API Key Required
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <h3 class="settings-title">Settings</h3>
        
        <!-- API Key Settings -->
        <div class="setting-section">
            <div class="setting-section-title">
                üîë YouTube API Settings
            </div>
            
            <div class="setting-item">
                <label class="setting-label">YouTube Data API v3 Key</label>
                <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your YouTube API key...">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn btn-small btn-test" id="testApiBtn">üß™ Test Key</button>
                    <button class="btn btn-small btn-instructions" id="instructionsBtn">üìñ How to Get Key</button>
                </div>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Security Warning</strong>
                    Keep your API key private! Set HTTP referrer restrictions in Google Cloud Console to protect your key from unauthorized use.
                </div>
                
                <div class="quota-info" id="quotaInfo">
                    <strong>üìä Daily Quota Usage</strong>
                    <div id="quotaText">API key required to track usage</div>
                    <div class="quota-bar">
                        <div class="quota-fill" id="quotaFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Playback Settings -->
        <div class="setting-section">
            <div class="setting-section-title">
                üé• Playback Settings
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Theme</label>
                <div class="setting-toggle" id="themeToggle">
                </div>
                <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">
                    <span id="themeLabel">Dark Mode</span>
                </small>
            </div>

            <div class="setting-item">
                <label class="setting-label">Auto-play Next in Playlist</label>
                <div class="setting-toggle" id="autoplayToggle">
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">Default Video Quality</label>
                <select class="setting-select" id="qualitySelect">
                    <option value="auto">Auto</option>
                    <option value="1080">1080p</option>
                    <option value="720">720p</option>
                    <option value="480">480p</option>
                </select>
            </div>

            <div class="setting-item">
                <label class="setting-label">Volume</label>
                <input type="range" min="0" max="100" value="80" id="volumeSlider" style="width: 100%; accent-color: var(--neon-pink);">
            </div>
        </div>

        <!-- Cache Settings -->
        <div class="setting-section">
            <div class="setting-section-title">
                üíæ Cache Settings
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Max History Items</label>
                <select class="setting-select" id="maxHistorySelect">
                    <option value="10">10 items</option>
                    <option value="20">20 items</option>
                    <option value="50">50 items</option>
                    <option value="100">100 items</option>
                </select>
            </div>

            <div class="setting-item">
                <button class="btn btn-small" id="clearCacheBtn" style="background: var(--text-secondary);">üóëÔ∏è Clear All Cache</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">NoChives Videos</h1>
            <p class="tagline">Premium YouTube Experience, Zero Cost</p>
        </header>

        <!-- Tabbed Interface -->
        <section class="player-section">
            <div class="tabs">
                <button class="tab active" data-tab="direct">üé¨ Direct Play</button>
                <button class="tab" data-tab="search">üîç Search Videos</button>
                <button class="tab" data-tab="playlist">üìã Browse Playlist</button>
                <button class="tab" data-tab="history">üìú Watch History</button>
            </div>

            <!-- Direct Play Tab -->
            <div class="tab-content active" id="directTab">
                <div class="video-input">
                    <input type="url" class="url-input" id="videoUrl" placeholder="Paste YouTube video or playlist URL here...">
                    <button class="play-btn" id="playBtn">‚ñ∂ Play Video</button>
                </div>

                <div class="video-container" id="videoContainer">
                    <div class="empty-state">
                        <div class="empty-icon">üé¨</div>
                        <div class="empty-text">Ready for Premium Playback</div>
                        <div class="empty-subtext">Paste a YouTube URL above to get started</div>
                    </div>
                </div>
            </div>

            <!-- Search Videos Tab -->
            <div class="tab-content" id="searchTab">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search YouTube videos...">
                    
                    <div class="search-filters">
                        <button class="filters-toggle" id="filtersToggle">
                            ‚öôÔ∏è Advanced Filters <span id="filtersArrow">‚ñº</span>
                        </button>
                        
                        <div class="filters-content" id="filtersContent">
                            <div class="filter-group">
                                <label class="filter-label">Max Results</label>
                                <select class="filter-select" id="maxResultsFilter">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Sort By</label>
                                <select class="filter-select" id="orderFilter">
                                    <option value="relevance">Most Relevant</option>
                                    <option value="date">Upload Date</option>
                                    <option value="rating">Rating</option>
                                    <option value="viewCount">View Count</option>
                                    <option value="title">Title</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Upload Date</label>
                                <select class="filter-select" id="dateFilter">
                                    <option value="">Any Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Duration</label>
                                <select class="filter-select" id="durationFilter">
                                    <option value="any">Any Duration</option>
                                    <option value="short">Short (&lt; 4 min)</option>
                                    <option value="medium">Medium (4-20 min)</option>
                                    <option value="long">Long (&gt; 20 min)</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Quality</label>
                                <select class="filter-select" id="qualityFilter">
                                    <option value="any">Any Quality</option>
                                    <option value="high">HD</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Region</label>
                                <select class="filter-select" id="regionFilter">
                                    <option value="HK">Hong Kong</option>
                                    <option value="US">United States</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="JP">Japan</option>
                                    <option value="KR">South Korea</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" id="searchBtn">üîç Search Videos</button>
                </div>
                
                <div id="searchResults"></div>
                <div id="searchPagination" class="pagination" style="display: none;"></div>
            </div>

            <!-- Browse Playlist Tab -->
            <div class="tab-content" id="playlistTab">
                <div class="video-input">
                    <input type="url" class="url-input" id="playlistUrl" placeholder="Paste YouTube playlist URL here...">
                    <button class="play-btn" id="loadPlaylistBtn">üìã Load Playlist</button>
                </div>
                
                <div id="playlistInfo" style="display: none;"></div>
                <div id="playlistVideos"></div>
            </div>

            <!-- Watch History Tab -->
            <div class="tab-content" id="historyTab">
                <div class="history-controls">
                    <h3 style="color: var(--text-primary); margin: 0;">Watch History</h3>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="search-input" id="historySearch" placeholder="Search history..." style="width: 200px; margin: 0;">
                        <button class="btn" id="exportHistoryBtn" style="padding: 0.7rem 1.5rem;">üìä Export CSV</button>
                        <button class="btn" id="clearAllHistoryBtn" style="padding: 0.7rem 1.5rem; background: var(--text-secondary);">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                <div id="historyTimeline"></div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features">
            <h2 class="section-title">Premium Features</h2>
            <div class="features-grid" id="featuresGrid">
                <!-- Features will be populated by JavaScript -->
            </div>
        </section>



        <!-- About Section -->
        <section class="about">
            <h2 class="section-title">About Me</h2>
            <div class="about-card">
                <div class="about-name">Acry Cheng</div>
                <div class="about-title">ADHD Visionary &amp; CEO</div>
                <div class="about-desc">
                    ADHD visionary who codes caffeine into reality, breaks rules for breakfast, and builds apps that slap harder than your ex's new Instagram story. If Elon and a cyberpunk hacker had a coding child, I'd be their cooler cousin.
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="donation-links">
                <a href="https://www.buymeacoffee.com" target="_blank" class="donation-btn">‚òï Buy Me a Coffee</a>
                <a href="#" class="donation-btn">üí≥ FPS Donate</a>
            </div>
            <div class="footer-text">Uses official YouTube Embed API. No content modification.</div>
            <div class="made-by">Made by Acry CEO</div>
        </div>
    </footer>

    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-prompt-content">
            <div class="install-prompt-text">
                <div class="install-prompt-title">Add to Home Screen</div>
                <div class="install-prompt-desc">Install NoChives Videos for a native app experience</div>
            </div>
            <div class="install-prompt-actions">
                <button class="install-btn" id="installBtn">Install</button>
                <button class="dismiss-btn" id="dismissBtn">Not Now</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        const state = {
            currentPlayer: null,
            currentVideo: null,
            history: [],
            searchResults: [],
            searchCache: new Map(),
            playlistCache: new Map(),
            currentPlaylist: null,
            quotaUsage: { date: '', units: 0, calls: [] },
            settings: {
                theme: 'dark',
                autoplay: true,
                quality: 'auto',
                volume: 80,
                maxHistory: 50,
                apiKey: ''
            },
            deferredPrompt: null,
            searchPagination: {
                nextPageToken: null,
                prevPageToken: null,
                currentPage: 1
            }
        };

        // Features Data
        const features = [
            {
                title: "Smart Video Search",
                description: "Search YouTube with advanced filters: date, duration, quality, sorting",
                icon: "üîç"
            },
            {
                title: "Playlist Reader",
                description: "Load and browse complete YouTube playlists with auto-play",
                icon: "üìã"
            },
            {
                title: "Ad-Free Playback",
                description: "Auto-filtered YouTube embed bypasses all ads",
                icon: "üö´"
            },
            {
                title: "Watch History",
                description: "Timeline view of all watched videos with search and export",
                icon: "üìú"
            },
            {
                title: "Background Play",
                description: "Audio continues when minimized (supported devices)",
                icon: "üéµ"
            },
            {
                title: "High Quality Support",
                description: "8K, 4K, 1080p support based on device capability",
                icon: "üé¨"
            },
            {
                title: "Quick Download",
                description: "Direct download via Cobalt.io integration",
                icon: "‚¨áÔ∏è"
            },
            {
                title: "Smart Caching",
                description: "Reduces API calls by caching search and playlist data",
                icon: "üíæ"
            },
            {
                title: "Quota Manager",
                description: "Track daily API usage to stay within limits",
                icon: "üìä"
            },
            {
                title: "PWA Support",
                description: "Install as app on mobile and desktop",
                icon: "üì±"
            }
        ];

        // DOM Elements
        const elements = {
            // General
            videoUrl: document.getElementById('videoUrl'),
            playBtn: document.getElementById('playBtn'),
            videoContainer: document.getElementById('videoContainer'),
            featuresGrid: document.getElementById('featuresGrid'),
            
            // API & Settings
            apiStatus: document.getElementById('apiStatus'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            testApiBtn: document.getElementById('testApiBtn'),
            instructionsBtn: document.getElementById('instructionsBtn'),
            quotaInfo: document.getElementById('quotaInfo'),
            quotaText: document.getElementById('quotaText'),
            quotaFill: document.getElementById('quotaFill'),
            
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            directTab: document.getElementById('directTab'),
            searchTab: document.getElementById('searchTab'),
            playlistTab: document.getElementById('playlistTab'),
            historyTab: document.getElementById('historyTab'),
            
            // Search
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            filtersToggle: document.getElementById('filtersToggle'),
            filtersContent: document.getElementById('filtersContent'),
            filtersArrow: document.getElementById('filtersArrow'),
            maxResultsFilter: document.getElementById('maxResultsFilter'),
            orderFilter: document.getElementById('orderFilter'),
            dateFilter: document.getElementById('dateFilter'),
            durationFilter: document.getElementById('durationFilter'),
            qualityFilter: document.getElementById('qualityFilter'),
            regionFilter: document.getElementById('regionFilter'),
            searchResults: document.getElementById('searchResults'),
            searchPagination: document.getElementById('searchPagination'),
            
            // Playlist
            playlistUrl: document.getElementById('playlistUrl'),
            loadPlaylistBtn: document.getElementById('loadPlaylistBtn'),
            playlistInfo: document.getElementById('playlistInfo'),
            playlistVideos: document.getElementById('playlistVideos'),
            
            // History
            historySearch: document.getElementById('historySearch'),
            exportHistoryBtn: document.getElementById('exportHistoryBtn'),
            clearAllHistoryBtn: document.getElementById('clearAllHistoryBtn'),
            historyTimeline: document.getElementById('historyTimeline'),
            
            // Settings Panel
            settingsToggle: document.getElementById('settingsToggle'),
            settingsPanel: document.getElementById('settingsPanel'),
            themeToggle: document.getElementById('themeToggle'),
            themeLabel: document.getElementById('themeLabel'),
            autoplayToggle: document.getElementById('autoplayToggle'),
            qualitySelect: document.getElementById('qualitySelect'),
            volumeSlider: document.getElementById('volumeSlider'),
            maxHistorySelect: document.getElementById('maxHistorySelect'),
            clearCacheBtn: document.getElementById('clearCacheBtn'),
            
            // PWA
            installPrompt: document.getElementById('installPrompt'),
            installBtn: document.getElementById('installBtn'),
            dismissBtn: document.getElementById('dismissBtn')
        };

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, type === 'warning' ? 5000 : 3000);
        }

        // YouTube API Functions
        function extractVideoId(url) {
            const videoPatterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]+)/,
                /m\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/
            ];
            
            const playlistPattern = /[?&]list=([a-zA-Z0-9_-]+)/;
            
            for (const pattern of videoPatterns) {
                const match = url.match(pattern);
                if (match) {
                    const playlistMatch = url.match(playlistPattern);
                    return { 
                        id: match[1], 
                        isPlaylist: false,
                        playlistId: playlistMatch ? playlistMatch[1] : null
                    };
                }
            }
            
            const playlistMatch = url.match(/(?:youtube\.com\/playlist\?list=)([a-zA-Z0-9_-]+)/);
            if (playlistMatch) {
                return { id: playlistMatch[1], isPlaylist: true };
            }
            
            return null;
        }
        
        function extractPlaylistId(url) {
            const patterns = [
                /[?&]list=([a-zA-Z0-9_-]+)/,
                /youtube\.com\/playlist\?list=([a-zA-Z0-9_-]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        function updateQuotaUsage(cost, type) {
            const today = new Date().toISOString().split('T')[0];
            
            if (state.quotaUsage.date !== today) {
                state.quotaUsage = { date: today, units: 0, calls: [] };
            }
            
            state.quotaUsage.units += cost;
            state.quotaUsage.calls.push({
                type: type,
                cost: cost,
                timestamp: new Date().toISOString()
            });
            
            updateQuotaDisplay();
            saveSettings();
            
            // Warn if approaching limit
            if (state.quotaUsage.units > 8000) {
                showToast(`Quota warning: ${state.quotaUsage.units}/10,000 units used today`, 'warning');
            }
        }
        
        function updateQuotaDisplay() {
            if (!elements.quotaText) return;
            
            const { units } = state.quotaUsage;
            const percentage = Math.min((units / 10000) * 100, 100);
            
            elements.quotaText.textContent = `${units}/10,000 units used today (${percentage.toFixed(1)}%)`;
            elements.quotaFill.style.width = `${percentage}%`;
            
            if (percentage > 80) {
                elements.quotaFill.style.background = 'linear-gradient(90deg, #FF0055, #e74c3c)';
            } else if (percentage > 60) {
                elements.quotaFill.style.background = 'linear-gradient(90deg, #FFD700, #f39c12)';
            } else {
                elements.quotaFill.style.background = 'linear-gradient(90deg, var(--cyber-green), var(--neon-blue), var(--neon-pink))';
            }
        }
        
        async function testApiKey(apiKey) {
            if (!apiKey) {
                showToast('Please enter an API key first', 'error');
                return false;
            }
            
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&maxResults=1&key=${apiKey}`);
                const data = await response.json();
                
                if (response.ok && data.items) {
                    showToast('API key is valid!', 'success');
                    updateApiStatus(true);
                    return true;
                } else {
                    const errorMsg = data.error?.message || 'Invalid API key';
                    showToast(`API key test failed: ${errorMsg}`, 'error');
                    updateApiStatus(false);
                    return false;
                }
            } catch (error) {
                showToast('Network error testing API key', 'error');
                updateApiStatus(false);
                return false;
            }
        }
        
        function updateApiStatus(isValid) {
            if (isValid) {
                elements.apiStatus.className = 'api-status valid';
                elements.apiStatus.textContent = 'üîë API Key Valid';
            } else {
                elements.apiStatus.className = 'api-status invalid';
                elements.apiStatus.textContent = 'üîë API Key Required';
            }
        }

        function saveToHistory(video) {
            const existingIndex = state.history.findIndex(item => item.id === video.id);
            if (existingIndex > -1) {
                state.history.splice(existingIndex, 1);
            }
            
            state.history.unshift({
                ...video,
                timestamp: Date.now(),
                source: getCurrentTabSource()
            });
            
            const maxHistory = parseInt(state.settings.maxHistory) || 50;
            if (state.history.length > maxHistory) {
                state.history = state.history.slice(0, maxHistory);
            }
            
            saveSettings();
            renderHistory();
        }
        
        function getCurrentTabSource() {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                switch (activeTab.dataset.tab) {
                    case 'search': return 'search';
                    case 'playlist': return 'playlist';
                    case 'history': return 'history';
                    default: return 'direct';
                }
            }
            return 'direct';
        }

        function saveSettings() {
            const data = {
                settings: state.settings,
                history: state.history,
                searchCache: Array.from(state.searchCache.entries()),
                playlistCache: Array.from(state.playlistCache.entries()),
                quotaUsage: state.quotaUsage,
                timestamp: Date.now()
            };
            
            try {
                const settings = JSON.stringify(data);
                // Use a global variable instead of localStorage
                window.noChivesData = settings;
                console.log('Settings saved to memory');
            } catch (error) {
                console.warn('Cannot save settings:', error.message);
            }
        }

        function loadSettings() {
            try {
                const data = window.noChivesData ? JSON.parse(window.noChivesData) : null;
                
                if (data) {
                    state.settings = { ...state.settings, ...data.settings };
                    state.history = data.history || [];
                    state.quotaUsage = data.quotaUsage || { date: '', units: 0, calls: [] };
                    
                    // Restore caches
                    if (data.searchCache) {
                        state.searchCache = new Map(data.searchCache);
                    }
                    if (data.playlistCache) {
                        state.playlistCache = new Map(data.playlistCache);
                    }
                    
                    // Clean old history (30 days)
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    state.history = state.history.filter(item => item.timestamp > thirtyDaysAgo);
                    
                    // Clean old cache (24 hours)
                    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                    for (const [key, value] of state.searchCache.entries()) {
                        if (value.timestamp < oneDayAgo) {
                            state.searchCache.delete(key);
                        }
                    }
                    for (const [key, value] of state.playlistCache.entries()) {
                        if (value.timestamp < oneDayAgo) {
                            state.playlistCache.delete(key);
                        }
                    }
                    
                    // Reset quota if new day
                    const today = new Date().toISOString().split('T')[0];
                    if (state.quotaUsage.date !== today) {
                        state.quotaUsage = { date: today, units: 0, calls: [] };
                    }
                }
            } catch (error) {
                console.warn('Cannot load settings:', error.message);
            }
        }

        // YouTube Player Functions
        function loadYouTubeAPI() {
            return new Promise((resolve) => {
                if (window.YT && window.YT.Player) {
                    resolve();
                    return;
                }
                
                window.onYouTubeIframeAPIReady = resolve;
                
                const script = document.createElement('script');
                script.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(script);
            });
        }

        function createPlayer(videoId, isPlaylist = false) {
            elements.videoContainer.innerHTML = '<div class="spinner"></div>';
            elements.videoContainer.classList.add('loading');

            const playerVars = {
                autoplay: 0,
                controls: 1,
                modestbranding: 1,
                rel: 0,
                fs: 1,
                enablejsapi: 1,
                origin: window.location.origin
            };

            if (isPlaylist) {
                playerVars.listType = 'playlist';
                playerVars.list = videoId;
            } else {
                playerVars.start = 0;
            }

            state.currentPlayer = new YT.Player(elements.videoContainer, {
                height: '450',
                width: '100%',
                videoId: isPlaylist ? null : videoId,
                playerVars: playerVars,
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange,
                    onError: onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            elements.videoContainer.classList.remove('loading');
            
            // Set volume
            event.target.setVolume(state.settings.volume);
            
            // Get video info and save to history
            try {
                const title = event.target.getVideoData().title;
                const videoId = event.target.getVideoData().video_id;
                
                if (title && videoId) {
                    const video = {
                        id: videoId,
                        title: title,
                        thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
                    };
                    
                    state.currentVideo = video;
                    saveToHistory(video);
                    
                    // Update video info
                    const videoInfo = document.createElement('div');
                    videoInfo.className = 'video-info';
                    videoInfo.innerHTML = `
                        <div class="video-title">${title}</div>
                        <div class="video-controls">
                            <button class="btn" onclick="downloadVideo('${videoId}')" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚¨áÔ∏è Download</button>
                        </div>
                    `;
                    
                    // Remove existing video info
                    const existingInfo = elements.videoContainer.querySelector('.video-info');
                    if (existingInfo) existingInfo.remove();
                    
                    elements.videoContainer.appendChild(videoInfo);
                }
            } catch (error) {
                console.warn('Could not get video info:', error);
            }
            
            showToast('Video loaded successfully!', 'success');
        }

        function onPlayerStateChange(event) {
            // Handle player state changes
            if (event.data === YT.PlayerState.ENDED && state.settings.autoplay) {
                // Auto-play next in playlist or history
                console.log('Video ended, autoplay enabled');
            }
        }

        function onPlayerError(event) {
            console.error('YouTube Player Error:', event.data);
            let errorMessage = 'Failed to load video';
            
            switch (event.data) {
                case 2:
                    errorMessage = 'Invalid video ID';
                    break;
                case 5:
                    errorMessage = 'HTML5 player error';
                    break;
                case 100:
                    errorMessage = 'Video not found or private';
                    break;
                case 101:
                case 150:
                    errorMessage = 'Video cannot be embedded';
                    break;
                default:
                    errorMessage = `Player error (code: ${event.data})`;
            }
            
            elements.videoContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ùå</div>
                    <div class="empty-text">Error Loading Video</div>
                    <div class="empty-subtext">${errorMessage}</div>
                </div>
            `;
            elements.videoContainer.classList.remove('loading');
            
            showToast(errorMessage, 'error');
        }

        // Download function
        function downloadVideo(videoId) {
            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
            const cobaltUrl = `https://cobalt.tools#${encodeURIComponent(videoUrl)}`;
            
            // Show modal with instructions
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            const modalContent = `
                <div style="
                    background: var(--dark-bg-card);
                    border: 2px solid var(--neon-pink);
                    border-radius: 15px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                ">
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Download Video</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">Click the button below to open Cobalt.tools with your video URL pre-filled for downloading.</p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <a href="${cobaltUrl}" target="_blank" class="btn" style="text-decoration: none;">‚¨áÔ∏è Open Cobalt.tools</a>
                        <button class="btn" style="background: var(--text-secondary);" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Remove modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            showToast('Opening Cobalt.tools for download', 'info');
        }

        // Render Functions
        function renderFeatures() {
            elements.featuresGrid.innerHTML = features.map(feature => `
                <div class="feature-card">
                    <span class="feature-icon">${feature.icon}</span>
                    <div class="feature-title">${feature.title}</div>
                    <div class="feature-desc">${feature.description}</div>
                </div>
            `).join('');
        }

        // Tab Management
        function switchTab(tabName) {
            elements.tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            elements.tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}Tab`) {
                    content.classList.add('active');
                }
            });
        }
        
        // Search Functions
        async function performSearch(pageToken = null) {
            const query = elements.searchInput.value.trim();
            if (!query) {
                showToast('Please enter a search query', 'error');
                return;
            }
            
            if (!state.settings.apiKey) {
                showToast('API key required for search', 'error');
                return;
            }
            
            // Show loading
            elements.searchResults.innerHTML = createLoadingGrid();
            
            // Get filters
            const filters = {
                maxResults: elements.maxResultsFilter.value,
                order: elements.orderFilter.value,
                regionCode: elements.regionFilter.value,
                videoDuration: elements.durationFilter.value,
                videoDefinition: elements.qualityFilter.value
            };
            
            // Add date filter
            const dateFilter = elements.dateFilter.value;
            if (dateFilter) {
                filters.publishedAfter = getDateFilter(dateFilter);
            }
            
            const results = await searchYouTubeVideos(query, filters, pageToken);
            if (results) {
                renderSearchResults(results);
                updateSearchPagination(results, query, filters);
            } else {
                elements.searchResults.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <div class="empty-text">Search Failed</div>
                        <div class="empty-subtext">Please check your API key and try again</div>
                    </div>
                `;
            }
        }
        
        function renderSearchResults(results) {
            if (!results.items || results.items.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">No videos found</div>
                        <div class="empty-subtext">Try different search terms or filters</div>
                    </div>
                `;
                return;
            }
            
            elements.searchResults.innerHTML = `
                <div class="search-results">
                    ${results.items.map(item => `
                        <div class="video-card" onclick="playSearchVideo('${item.id.videoId}', '${item.snippet.title.replace(/'/g, '\\'')}')">
                            <div class="video-thumbnail">
                                <img src="${item.snippet.thumbnails.medium.url}" alt="${item.snippet.title}" loading="lazy">
                            </div>
                            <div class="video-card-content">
                                <div class="video-card-title" title="${item.snippet.title}">
                                    ${item.snippet.title}
                                </div>
                                <div class="video-card-channel">${item.snippet.channelTitle}</div>
                                <div class="video-card-meta">
                                    <span>${formatPublishDate(item.snippet.publishedAt)}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function updateSearchPagination(results, query, filters) {
            const { nextPageToken, prevPageToken } = results;
            
            if (nextPageToken || prevPageToken) {
                elements.searchPagination.style.display = 'flex';
                elements.searchPagination.innerHTML = `
                    <button class="pagination-btn" 
                            onclick="performSearch('${prevPageToken || ''}')"
                            ${!prevPageToken ? 'disabled' : ''}>
                        ‚óÄ Previous
                    </button>
                    <span style="color: var(--text-secondary); display: flex; align-items: center;">
                        Page ${state.searchPagination.currentPage}
                    </span>
                    <button class="pagination-btn" 
                            onclick="performSearch('${nextPageToken || ''}')"
                            ${!nextPageToken ? 'disabled' : ''}>
                        Next ‚ñ∂
                    </button>
                `;
            } else {
                elements.searchPagination.style.display = 'none';
            }
        }
        
        function playSearchVideo(videoId, title) {
            switchTab('direct');
            elements.videoUrl.value = `https://www.youtube.com/watch?v=${videoId}`;
            playVideo();
        }
        
        // Playlist Functions
        async function loadPlaylist() {
            const url = elements.playlistUrl.value.trim();
            if (!url) {
                showToast('Please enter a playlist URL', 'error');
                return;
            }
            
            if (!state.settings.apiKey) {
                showToast('API key required for playlists', 'error');
                return;
            }
            
            const playlistId = extractPlaylistId(url);
            if (!playlistId) {
                showToast('Invalid playlist URL', 'error');
                return;
            }
            
            // Show loading
            elements.playlistInfo.style.display = 'none';
            elements.playlistVideos.innerHTML = '<div class="spinner" style="margin: 2rem auto;"></div>';
            
            const results = await getPlaylistItems(playlistId);
            if (results) {
                renderPlaylist(results, playlistId);
            } else {
                elements.playlistVideos.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <div class="empty-text">Failed to Load Playlist</div>
                        <div class="empty-subtext">Please check the URL and try again</div>
                    </div>
                `;
            }
        }
        
        function renderPlaylist(results, playlistId) {
            if (!results.items || results.items.length === 0) {
                elements.playlistVideos.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-text">Empty Playlist</div>
                        <div class="empty-subtext">This playlist has no videos</div>
                    </div>
                `;
                return;
            }
            
            // Get playlist info from first item
            const firstItem = results.items[0];
            const playlistTitle = firstItem.snippet.channelTitle + ' Playlist';
            const totalVideos = results.pageInfo.totalResults;
            
            // Show playlist info
            elements.playlistInfo.style.display = 'block';
            elements.playlistInfo.innerHTML = `
                <div class="playlist-info">
                    <div class="playlist-title">${playlistTitle}</div>
                    <div class="playlist-meta">${totalVideos} videos</div>
                    <div class="playlist-controls">
                        <button class="btn" onclick="playAllPlaylist('${playlistId}')">‚ñ∂ Play All</button>
                        <button class="btn" onclick="shufflePlaylist('${playlistId}')" style="background: var(--electric-purple);">üîÄ Shuffle</button>
                        <button class="btn" onclick="exportPlaylist('${playlistId}')" style="background: var(--text-secondary);">üìä Export JSON</button>
                    </div>
                </div>
            `;
            
            // Render videos
            elements.playlistVideos.innerHTML = `
                <div class="playlist-videos">
                    ${results.items.map((item, index) => {
                        if (!item.snippet.title || item.snippet.title === 'Deleted video' || item.snippet.title === 'Private video') {
                            return '';
                        }
                        
                        return `
                            <div class="playlist-video" onclick="playPlaylistVideo('${item.snippet.resourceId.videoId}', ${JSON.stringify(item.snippet.title)})">
                                <div class="playlist-position">${index + 1}</div>
                                <div class="playlist-video-thumbnail">
                                    <img src="${item.snippet.thumbnails.medium.url}" alt="${item.snippet.title}" loading="lazy">
                                </div>
                                <div class="playlist-video-content">
                                    <div class="playlist-video-title">${item.snippet.title}</div>
                                    <div class="playlist-video-meta">
                                        <span>${formatPublishDate(item.snippet.publishedAt)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).filter(html => html).join('')}
                </div>
            `;
            
            // Store current playlist
            state.currentPlaylist = {
                id: playlistId,
                items: results.items.filter(item => 
                    item.snippet.title && 
                    item.snippet.title !== 'Deleted video' && 
                    item.snippet.title !== 'Private video'
                )
            };
        }
        
        function playPlaylistVideo(videoId, title) {
            switchTab('direct');
            elements.videoUrl.value = `https://www.youtube.com/watch?v=${videoId}`;
            playVideo();
        }
        
        function playAllPlaylist(playlistId) {
            if (state.currentPlaylist && state.currentPlaylist.items.length > 0) {
                const firstVideo = state.currentPlaylist.items[0];
                switchTab('direct');
                elements.videoUrl.value = `https://www.youtube.com/watch?v=${firstVideo.snippet.resourceId.videoId}&list=${playlistId}`;
                playVideo();
                showToast('Playing all videos in playlist', 'success');
            }
        }
        
        function shufflePlaylist(playlistId) {
            if (state.currentPlaylist && state.currentPlaylist.items.length > 0) {
                const randomIndex = Math.floor(Math.random() * state.currentPlaylist.items.length);
                const randomVideo = state.currentPlaylist.items[randomIndex];
                switchTab('direct');
                elements.videoUrl.value = `https://www.youtube.com/watch?v=${randomVideo.snippet.resourceId.videoId}&list=${playlistId}`;
                playVideo();
                showToast(`Playing random video (${randomIndex + 1} of ${state.currentPlaylist.items.length})`, 'success');
            }
        }
        
        function exportPlaylist(playlistId) {
            if (!state.currentPlaylist) {
                showToast('No playlist data to export', 'error');
                return;
            }
            
            const exportData = {
                playlistId: playlistId,
                exportedAt: new Date().toISOString(),
                totalVideos: state.currentPlaylist.items.length,
                videos: state.currentPlaylist.items.map((item, index) => ({
                    position: index + 1,
                    videoId: item.snippet.resourceId.videoId,
                    title: item.snippet.title,
                    channel: item.snippet.channelTitle,
                    publishedAt: item.snippet.publishedAt,
                    url: `https://www.youtube.com/watch?v=${item.snippet.resourceId.videoId}`
                }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `playlist_${playlistId}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            
            showToast('Playlist exported successfully!', 'success');
        }
        
        // History Functions
        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyTimeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì∫</div>
                        <div class="empty-text">No videos watched yet</div>
                        <div class="empty-subtext">Your recently played videos will appear here</div>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const groupedHistory = {};
            state.history.forEach(video => {
                const date = new Date(video.timestamp).toLocaleDateString();
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(video);
            });
            
            elements.historyTimeline.innerHTML = Object.entries(groupedHistory)
                .map(([date, videos]) => `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--neon-blue); margin-bottom: 1rem; font-size: 1.1rem;">${date}</h4>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${videos.map(video => {
                                const thumbnailUrl = video.thumbnail || `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;
                                const title = video.title || 'Untitled Video';
                                const source = video.source || 'direct';
                                const timeString = new Date(video.timestamp).toLocaleTimeString();
                                
                                return `
                                    <div class="playlist-video" onclick="playHistoryVideo('${video.id}')">
                                        <div class="playlist-video-thumbnail">
                                            <img src="${thumbnailUrl}" alt="${title}" loading="lazy">
                                        </div>
                                        <div class="playlist-video-content">
                                            <div class="playlist-video-title">${title}</div>
                                            <div class="playlist-video-meta">
                                                <span>${source}</span>
                                                <span>${timeString}</span>
                                            </div>
                                        </div>
                                        <button class="btn btn-small" onclick="event.stopPropagation(); removeFromHistory('${video.id}')" 
                                                style="background: var(--text-secondary); margin: 0 1rem;">üóëÔ∏è</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
        }
        
        function filterHistory(searchTerm) {
            if (!searchTerm) {
                renderHistory();
                return;
            }
            
            const filtered = state.history.filter(video => 
                video.title && video.title.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filtered.length === 0) {
                elements.historyTimeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">No matching videos</div>
                        <div class="empty-subtext">Try different search terms</div>
                    </div>
                `;
                return;
            }
            
            elements.historyTimeline.innerHTML = filtered.map(video => {
                const thumbnailUrl = video.thumbnail || `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;
                const title = video.title || 'Untitled Video';
                const source = video.source || 'direct';
                const timeString = new Date(video.timestamp).toLocaleString();
                
                return `
                    <div class="playlist-video" onclick="playHistoryVideo('${video.id}')" style="margin-bottom: 1rem;">
                        <div class="playlist-video-thumbnail">
                            <img src="${thumbnailUrl}" alt="${title}" loading="lazy">
                        </div>
                        <div class="playlist-video-content">
                            <div class="playlist-video-title">${title}</div>
                            <div class="playlist-video-meta">
                                <span>${source}</span>
                                <span>${timeString}</span>
                            </div>
                        </div>
                        <button class="btn btn-small" onclick="event.stopPropagation(); removeFromHistory('${video.id}')" 
                                style="background: var(--text-secondary); margin: 0 1rem;">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeFromHistory(videoId) {
            state.history = state.history.filter(video => video.id !== videoId);
            saveSettings();
            renderHistory();
            showToast('Video removed from history', 'success');
        }
        
        function exportHistory() {
            if (state.history.length === 0) {
                showToast('No history to export', 'error');
                return;
            }
            
            const csvHeaders = 'Title,Video ID,Channel,Watched At,Source,URL\n';
            const csvData = state.history.map(video => {
                const title = (video.title || 'Untitled').replace(/"/g, '""');
                const channel = (video.channel || 'Unknown').replace(/"/g, '""');
                const watchedAt = new Date(video.timestamp).toISOString();
                const source = video.source || 'direct';
                const url = `https://www.youtube.com/watch?v=${video.id}`;
                return `"${title}","${video.id}","${channel}","${watchedAt}","${source}","${url}"`;
            }).join('\n');
            
            const blob = new Blob([csvHeaders + csvData], { type: 'text/csv' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `nochives_history_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            
            showToast('History exported successfully!', 'success');
        }
        
        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all watch history?')) {
                state.history = [];
                saveSettings();
                renderHistory();
                showToast('History cleared', 'success');
            }
        }
        
        // Helper functions
        function createLoadingGrid() {
            return `
                <div class="loading-grid">
                    ${Array(6).fill().map(() => `
                        <div class="loading-card">
                            <div class="loading-thumbnail"></div>
                            <div class="loading-content">
                                <div class="loading-line"></div>
                                <div class="loading-line short"></div>
                                <div class="loading-line short"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function playHistoryVideo(videoId) {
            switchTab('direct');
            elements.videoUrl.value = `https://www.youtube.com/watch?v=${videoId}`;
            playVideo();
        }

        // YouTube Data API Functions
        async function searchYouTubeVideos(query, filters = {}, pageToken = null) {
            if (!state.settings.apiKey) {
                showToast('YouTube API key required for search', 'error');
                return null;
            }
            
            // Check cache first
            const cacheKey = JSON.stringify({ query, filters, pageToken });
            const cached = state.searchCache.get(cacheKey);
            if (cached && (Date.now() - cached.timestamp < 3600000)) { // 1 hour
                return cached.data;
            }
            
            try {
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&key=${state.settings.apiKey}&q=${encodeURIComponent(query)}`;
                
                // Add filters
                if (filters.maxResults) url += `&maxResults=${filters.maxResults}`;
                if (filters.order) url += `&order=${filters.order}`;
                if (filters.regionCode) url += `&regionCode=${filters.regionCode}`;
                if (filters.videoDuration && filters.videoDuration !== 'any') url += `&videoDuration=${filters.videoDuration}`;
                if (filters.videoDefinition && filters.videoDefinition !== 'any') url += `&videoDefinition=${filters.videoDefinition}`;
                if (filters.publishedAfter) url += `&publishedAfter=${filters.publishedAfter}`;
                if (pageToken) url += `&pageToken=${pageToken}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    // Cache the results
                    state.searchCache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    // Update quota
                    updateQuotaUsage(100, 'search');
                    
                    return data;
                } else {
                    const errorMsg = data.error?.message || 'Search failed';
                    showToast(`Search error: ${errorMsg}`, 'error');
                    return null;
                }
            } catch (error) {
                console.error('Search error:', error);
                showToast('Network error during search', 'error');
                return null;
            }
        }
        
        async function getPlaylistItems(playlistId, pageToken = null) {
            if (!state.settings.apiKey) {
                showToast('YouTube API key required for playlists', 'error');
                return null;
            }
            
            // Check cache first
            const cacheKey = `playlist_${playlistId}_${pageToken || 'first'}`;
            const cached = state.playlistCache.get(cacheKey);
            if (cached && (Date.now() - cached.timestamp < 3600000)) { // 1 hour
                return cached.data;
            }
            
            try {
                let url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&key=${state.settings.apiKey}&playlistId=${playlistId}`;
                if (pageToken) url += `&pageToken=${pageToken}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    // Cache the results
                    state.playlistCache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });
                    
                    // Update quota
                    updateQuotaUsage(1, 'playlist');
                    
                    return data;
                } else {
                    const errorMsg = data.error?.message || 'Playlist load failed';
                    showToast(`Playlist error: ${errorMsg}`, 'error');
                    return null;
                }
            } catch (error) {
                console.error('Playlist error:', error);
                showToast('Network error loading playlist', 'error');
                return null;
            }
        }
        
        // Date filter helpers
        function getDateFilter(period) {
            const now = new Date();
            let date;
            
            switch (period) {
                case 'today':
                    date = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    date = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    date = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    date = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return null;
            }
            
            return date.toISOString();
        }
        
        // Format duration for display
        function formatDuration(duration) {
            if (!duration) return 'N/A';
            
            // Parse ISO 8601 duration (PT1H2M3S)
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 'N/A';
            
            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Format view count
        function formatViewCount(viewCount) {
            if (!viewCount) return 'N/A';
            
            const count = parseInt(viewCount);
            if (count >= 1000000) {
                return `${(count / 1000000).toFixed(1)}M views`;
            } else if (count >= 1000) {
                return `${(count / 1000).toFixed(1)}K views`;
            } else {
                return `${count} views`;
            }
        }
        
        // Format publish date
        function formatPublishDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return '1 day ago';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                return `${months} month${months > 1 ? 's' : ''} ago`;
            } else {
                const years = Math.floor(diffDays / 365);
                return `${years} year${years > 1 ? 's' : ''} ago`;
            }
        }
        
        // Main Functions
        async function playVideo() {
            const url = elements.videoUrl.value.trim();
            
            if (!url) {
                showToast('Please enter a YouTube URL', 'error');
                return;
            }
            
            const videoInfo = extractVideoId(url);
            if (!videoInfo) {
                showToast('Invalid YouTube URL', 'error');
                return;
            }
            
            try {
                await loadYouTubeAPI();
                createPlayer(videoInfo.id, videoInfo.isPlaylist);
            } catch (error) {
                console.error('Error loading video:', error);
                showToast('Failed to load video player', 'error');
            }
        }

        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', state.settings.theme);
            elements.themeLabel.textContent = state.settings.theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            saveSettings();
        }

        // API Key Instructions Modal
        function showApiKeyInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--dark-bg-card);
                    border: 2px solid var(--neon-blue);
                    border-radius: 15px;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <h3 style="color: var(--neon-blue); margin-bottom: 1rem; font-family: 'Orbitron', monospace;">üîë How to Get YouTube Data API Key</h3>
                    
                    <div style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 2rem;">
                        <ol style="margin-left: 1.5rem;">
                            <li style="margin-bottom: 0.5rem;">Go to <strong>Google Cloud Console</strong> (console.cloud.google.com)</li>
                            <li style="margin-bottom: 0.5rem;">Create a new project or select existing one</li>
                            <li style="margin-bottom: 0.5rem;">Enable <strong>'YouTube Data API v3'</strong> in the APIs library</li>
                            <li style="margin-bottom: 0.5rem;">Go to <strong>Credentials</strong> and create API Key</li>
                            <li style="margin-bottom: 0.5rem;">Set <strong>HTTP referrer restrictions</strong> for security</li>
                            <li style="margin-bottom: 0.5rem;">Copy API key and paste it in NoChives Videos</li>
                        </ol>
                        
                        <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <strong style="color: #FFD700;">‚ö†Ô∏è Security Tips:</strong><br>
                            ‚Ä¢ Never share your API key publicly<br>
                            ‚Ä¢ Set domain restrictions in Google Cloud Console<br>
                            ‚Ä¢ Monitor your quota usage regularly<br>
                            ‚Ä¢ Revoke and regenerate if compromised
                        </div>
                        
                        <div style="background: rgba(0, 217, 255, 0.1); border: 1px solid var(--neon-blue); border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <strong style="color: var(--neon-blue);">üìä Quota Information:</strong><br>
                            ‚Ä¢ Daily limit: 10,000 units<br>
                            ‚Ä¢ Search cost: 100 units per request<br>
                            ‚Ä¢ Playlist cost: 1 unit per request<br>
                            ‚Ä¢ Free tier available for personal use
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <a href="https://console.cloud.google.com" target="_blank" class="btn" style="text-decoration: none;">üöÄ Open Google Cloud</a>
                        <button class="btn" style="background: var(--text-secondary);" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Remove modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Event Listeners
        function initEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });
            
            // Direct Play Tab
            elements.playBtn.addEventListener('click', playVideo);
            elements.videoUrl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') playVideo();
            });
            
            // Search Tab
            elements.searchBtn.addEventListener('click', () => performSearch());
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            // Search filters toggle
            elements.filtersToggle.addEventListener('click', () => {
                const isOpen = elements.filtersContent.classList.toggle('open');
                elements.filtersArrow.textContent = isOpen ? '‚ñ≤' : '‚ñº';
            });
            
            // Playlist Tab
            elements.loadPlaylistBtn.addEventListener('click', loadPlaylist);
            elements.playlistUrl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadPlaylist();
            });
            
            // History Tab
            elements.historySearch.addEventListener('input', (e) => {
                filterHistory(e.target.value);
            });
            elements.exportHistoryBtn.addEventListener('click', exportHistory);
            elements.clearAllHistoryBtn.addEventListener('click', clearAllHistory);
            
            // API Key Management
            elements.apiKeyInput.addEventListener('input', (e) => {
                state.settings.apiKey = e.target.value.trim();
                saveSettings();
                updateApiStatus(!!e.target.value);
            });
            
            elements.testApiBtn.addEventListener('click', () => {
                const apiKey = elements.apiKeyInput.value.trim();
                if (apiKey) {
                    testApiKey(apiKey);
                } else {
                    showToast('Please enter an API key first', 'error');
                }
            });
            
            elements.instructionsBtn.addEventListener('click', showApiKeyInstructions);
            
            // Settings Panel
            elements.settingsToggle.addEventListener('click', () => {
                elements.settingsPanel.classList.toggle('open');
            });
            
            // Click outside to close settings
            document.addEventListener('click', (e) => {
                if (!elements.settingsPanel.contains(e.target) && e.target !== elements.settingsToggle) {
                    elements.settingsPanel.classList.remove('open');
                }
            });
            
            // Theme toggle
            elements.themeToggle.addEventListener('click', () => {
                elements.themeToggle.classList.toggle('active');
                toggleTheme();
            });
            
            // Autoplay toggle
            elements.autoplayToggle.addEventListener('click', () => {
                elements.autoplayToggle.classList.toggle('active');
                state.settings.autoplay = elements.autoplayToggle.classList.contains('active');
                saveSettings();
            });
            
            // Settings selects
            elements.qualitySelect.addEventListener('change', (e) => {
                state.settings.quality = e.target.value;
                saveSettings();
            });
            
            elements.maxHistorySelect.addEventListener('change', (e) => {
                state.settings.maxHistory = parseInt(e.target.value);
                saveSettings();
                // Trim history if needed
                if (state.history.length > state.settings.maxHistory) {
                    state.history = state.history.slice(0, state.settings.maxHistory);
                    renderHistory();
                }
            });
            
            // Volume slider
            elements.volumeSlider.addEventListener('input', (e) => {
                state.settings.volume = parseInt(e.target.value);
                if (state.currentPlayer && state.currentPlayer.setVolume) {
                    state.currentPlayer.setVolume(state.settings.volume);
                }
                saveSettings();
            });
            
            // Clear cache
            elements.clearCacheBtn.addEventListener('click', () => {
                if (confirm('Clear all cached data? This will remove search and playlist cache.')) {
                    state.searchCache.clear();
                    state.playlistCache.clear();
                    saveSettings();
                    showToast('Cache cleared successfully', 'success');
                }
            });
            
            // PWA Install
            elements.installBtn.addEventListener('click', () => {
                if (state.deferredPrompt) {
                    state.deferredPrompt.prompt();
                    state.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showToast('App installed successfully!', 'success');
                        }
                        state.deferredPrompt = null;
                        elements.installPrompt.classList.remove('show');
                    });
                } else {
                    showToast('Installation not available', 'info');
                    elements.installPrompt.classList.remove('show');
                }
            });
            
            elements.dismissBtn.addEventListener('click', () => {
                elements.installPrompt.classList.remove('show');
                state.settings.installDismissed = true;
                saveSettings();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    // Don't interfere with input fields
                    if (e.key === '/' && e.target === document.body) {
                        e.preventDefault();
                        elements.searchInput.focus();
                        switchTab('search');
                    }
                    return;
                }
                
                switch (e.key) {
                    case ' ':
                        e.preventDefault();
                        if (state.currentPlayer) {
                            const playerState = state.currentPlayer.getPlayerState();
                            if (playerState === 1) { // Playing
                                state.currentPlayer.pauseVideo();
                            } else if (playerState === 2) { // Paused
                                state.currentPlayer.playVideo();
                            }
                        }
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        if (state.currentPlayer && state.currentPlayer.getIframe()) {
                            state.currentPlayer.getIframe().requestFullscreen();
                        }
                        break;
                    case 'm':
                    case 'M':
                        e.preventDefault();
                        if (state.currentPlayer) {
                            if (state.currentPlayer.isMuted()) {
                                state.currentPlayer.unMute();
                            } else {
                                state.currentPlayer.mute();
                            }
                        }
                        break;
                    case '/':
                        e.preventDefault();
                        elements.searchInput.focus();
                        switchTab('search');
                        break;
                }
            });
        }

        // PWA Support
        function initPWA() {
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                
                if (!state.settings.installDismissed) {
                    setTimeout(() => {
                        elements.installPrompt.classList.add('show');
                    }, 5000);
                }
            });
            
            // Listen for app installed
            window.addEventListener('appinstalled', () => {
                showToast('NoChives Videos installed!', 'success');
                state.deferredPrompt = null;
            });
        }

        // Apply saved settings
        function applySettings() {
            // Theme
            document.body.setAttribute('data-theme', state.settings.theme);
            elements.themeLabel.textContent = state.settings.theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            if (state.settings.theme === 'light') {
                elements.themeToggle.classList.add('active');
            }
            
            // Autoplay
            if (state.settings.autoplay) {
                elements.autoplayToggle.classList.add('active');
            }
            
            // Settings
            elements.qualitySelect.value = state.settings.quality;
            elements.volumeSlider.value = state.settings.volume;
            elements.maxHistorySelect.value = state.settings.maxHistory || 50;
            
            // API Key
            if (state.settings.apiKey) {
                elements.apiKeyInput.value = state.settings.apiKey;
                updateApiStatus(true);
            } else {
                updateApiStatus(false);
            }
            
            // Update quota display
            updateQuotaDisplay();
        }

        // Initialize App
        function init() {
            console.log('Initializing NoChives Videos with API integration...');
            
            loadSettings();
            renderFeatures();
            renderHistory();
            initEventListeners();
            initPWA();
            applySettings();
            
            // Check API key status on load
            if (state.settings.apiKey) {
                testApiKey(state.settings.apiKey);
            }
            
            console.log('NoChives Videos initialized successfully');
            showToast('Welcome to NoChives Videos! üöÄ', 'success');
            
            // Show API key notice if not set
            if (!state.settings.apiKey) {
                setTimeout(() => {
                    showToast('Set your YouTube API key in Settings for search and playlist features', 'info');
                }, 3000);
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
